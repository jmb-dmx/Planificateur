<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title id="pageTitle">Skylight Lavaltrie</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #F8FAFC; --card: #FFFFFF; --text: #1E293B; --text-muted: #64748B;
            --border: #E2E8F0; --primary: #0EA5E9; --accent: #F59E0B;
            --today-bg: #F0F9FF; --today-border: #0EA5E9;
            --header-bg: #1e293b;
            --zoom-factor: 1;
            --cell-size: calc(min(calc((100vw - 380px) / 7), calc((100vh - 220px) / 6)) * var(--zoom-factor));
            --font-main: 'Plus Jakarta Sans', sans-serif;
        }
        body.dark-mode {
            --bg: #0F172A; --card: #1E293B; --text: #F1F5F9; --text-muted: #94A3B8;
            --border: #334155; --primary: #38BDF8; --today-bg: #1E293B; --today-border: #38BDF8;
        }

        html, body { height: 100vh; width: 100vw; margin: 0; padding: 0; overflow: hidden; display: flex; flex-direction: column; font-family: var(--font-main); background: var(--bg); color: var(--text); transition: all 0.3s ease; font-size: 18px; }
        .header { flex-shrink: 0; height: 85px; padding: 0 25px; display: flex; justify-content: space-between; align-items: center; background: var(--header-bg); color: white; z-index: 10; }
        .header-section { display: flex; align-items: center; gap: 12px; }
        .weather-box { font-weight: 700; font-size: 0.95rem; min-width: 100px; }
        .month-display { font-size: 1.6rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
        .clock-box { font-size: 1.8rem; font-weight: 800; color: #38BDF8; }
        .nav-btn, .action-btn { background: rgba(255,255,255,0.1); border: none; color: white; padding: 10px; border-radius: 8px; cursor: pointer; }
        .btn-today { background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 10px; font-weight: 800; cursor: pointer; }

        #importantBanner { display: none; background: var(--accent); color: #000; padding: 10px; text-align: center; font-weight: 800; font-size: 1rem; border-bottom: 2px solid rgba(0,0,0,0.1); z-index: 5; }

        .main-content { display: flex; flex-grow: 1; overflow: hidden; position: relative; }
        .calendar-container { flex-grow: 1; padding: 10px; overflow: auto; display: flex; flex-direction: column; align-items: center; }
        .calendar-wrapper { display: flex; flex-direction: column; align-items: center; min-width: max-content; }
        .week-days-header { display: grid; grid-template-columns: repeat(7, var(--cell-size)); gap: 8px; margin-bottom: 10px; text-align: center; font-weight: 800; font-size: 0.8rem; color: var(--text-muted); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, var(--cell-size)); grid-template-rows: repeat(6, var(--cell-size)); gap: 8px; }

        .day-card { background: var(--card); border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; padding: 5px; cursor: pointer; position: relative; width: var(--cell-size); height: var(--cell-size); box-sizing: border-box; overflow: hidden; transition: width 0.2s, height 0.2s; }
        .day-card.today { border: 3px solid var(--today-border); background: var(--today-bg); }
        .day-number { font-size: 1.1rem; font-weight: 800; margin-bottom: 4px; }

        .waste-icons { position: absolute; top: 5px; right: 5px; display: flex; gap: 3px; z-index: 5; }
        .bin { font-size: 1.1rem; }
        .bin-blue { color: #3b82f6; } .bin-green { color: #22c55e; } .bin-black { color: #64748b; }

        .events-container { position: relative; flex-grow: 1; width: 100%; display: flex; flex-direction: column; gap: 4px; }
        .event { position: relative; width: 100%; height: 42%; padding: 4px 6px; border-radius: 6px; border-left: 4px solid rgba(0,0,0,0.2); color: #1A1A1A; display: none; flex-direction: column; justify-content: center; box-sizing: border-box; overflow: hidden; }
        .event.visible { display: flex; }
        .event-title { font-size: 0.85rem; font-weight: 800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display:flex; align-items:center; gap:4px; }

        /* ICI : RECOUCHAGE DE L'HEURE */
        .event-time-line { font-size: 0.65rem; font-weight: 700; color: rgba(0,0,0,0.6); margin-top: 1px; white-space: nowrap; }

        .event-important-star { position: absolute; bottom: 2px; right: 2px; font-size: 0.6rem; color: var(--accent); }

        #taskPanel { width: 380px; background: var(--card); border-left: 2px solid var(--border); display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s ease; position: absolute; right: 0; top: 0; bottom: 0; z-index: 20; }
        #taskPanel.open { transform: translateX(0); position: relative; }
        .btn-toggle-tasks { position: absolute; left: -45px; top: 50%; transform: translateY(-50%); background: var(--header-bg); color: white; border: none; padding: 20px 10px; border-radius: 12px 0 0 12px; cursor: pointer; writing-mode: vertical-lr; font-weight: 800; }

        .tab-btn { flex: 1; padding: 15px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; font-size: 1.2rem; transition: 0.3s; }
        .tab-btn.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: var(--card); }
        .tab-content { display: none; flex-direction: column; height: calc(100% - 55px); }
        .tab-content.active { display: flex; }

        #modalOverlay, #settingsOverlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
        .modal { background: var(--card); padding: 25px; border-radius: 24px; width: 90%; max-width: 480px; border: 1px solid var(--border); color: var(--text); max-height: 85vh; overflow-y: auto; }
        .input-box { width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 0.95rem; box-sizing: border-box; }
        .footer-btn { flex: 1; padding: 15px; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 6px; }
    </style>
</head>
<body id="bodyRoot">

<div class="header">
    <div class="header-section">
        <div id="weatherWidget" class="weather-box">üå§Ô∏è --¬∞C</div>
    </div>
    <div class="header-section">
        <button onclick="changeZoom(-0.1)" class="nav-btn" title="R√©duire"><i class="fa-solid fa-minus"></i></button>
        <button onclick="changeMonth(-1)" class="nav-btn"><i class="fa-solid fa-chevron-left"></i></button>
        <div id="monthDisplay" class="month-display">...</div>
        <button onclick="changeMonth(1)" class="nav-btn"><i class="fa-solid fa-chevron-right"></i></button>
        <button onclick="changeZoom(0.1)" class="nav-btn" title="Grossir"><i class="fa-solid fa-plus"></i></button>
    </div>
    <div class="header-section">
        <div id="clock" class="clock-box">00:00</div>
        <button onclick="goToday()" class="btn-today">AUJOURD'HUI</button>
        <button onclick="togglePhotoFrame(true)" class="action-btn" title="Cadre Photo"><i class="fa-solid fa-camera"></i></button>
        <button onclick="toggleScreen(0)" class="action-btn" title="Mettre en veille"><i class="fa-solid fa-moon"></i></button>
        <button onclick="openSettings()" class="action-btn"><i class="fa-solid fa-gear"></i></button>
    </div>
</div>

<div id="importantBanner">
    <i class="fa-solid fa-star"></i> <span id="bannerText"></span>
</div>

<div class="main-content">
    <div class="calendar-container">
        <div class="calendar-wrapper">
            <div class="week-days-header"><div>Dim</div><div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div><div>Ven</div><div>Sam</div></div>
            <div id="calendar" class="calendar-grid"></div>
        </div>
    </div>

    <div id="taskPanel">
        <button class="btn-toggle-tasks" onclick="toggleTasks()">MENU</button>

        <div style="display:flex; border-bottom:1px solid var(--border); background:var(--bg);">
            <button class="tab-btn active" onclick="showTab('tasks')"><i class="fa-solid fa-check-double"></i></button>
            <button class="tab-btn" onclick="showTab('shopping')"><i class="fa-solid fa-cart-shopping"></i></button>
            <button class="tab-btn" onclick="showTab('meals')"><i class="fa-solid fa-utensils"></i></button>
            <button class="tab-btn" onclick="showTab('notes')"><i class="fa-solid fa-note-sticky"></i></button>
        </div>

        <!-- T√ÇCHES -->
        <div id="tab-tasks" class="tab-content active">
            <div id="taskMemberSelector" style="display:flex; flex-wrap:wrap; gap:5px; padding:10px; background:var(--bg); border-bottom:1px solid var(--border);"></div>
            <div style="padding:15px; font-weight:800; border-bottom:1px solid var(--border)">√Ä FAIRE</div>
            <div id="taskList" style="flex-grow:1; overflow-y:auto; padding:15px;"></div>
            <div style="padding:15px; display:flex; gap:8px;">
                <input type="text" id="newTaskInput" class="input-box" style="margin:0" placeholder="Nouvelle t√¢che...">
                <button onclick="addTask()" style="background:var(--primary); color:white; border:none; padding:0 15px; border-radius:10px;"><i class="fa-solid fa-plus"></i></button>
            </div>
        </div>

        <!-- COURSES -->
        <div id="tab-shopping" class="tab-content">
            <div style="padding:15px; font-weight:800; border-bottom:1px solid var(--border)">LISTE DE COURSES</div>
            <div id="shoppingList" style="flex-grow:1; overflow-y:auto; padding:15px;"></div>
            <div style="padding:15px; display:flex; gap:8px;">
                <input type="text" id="newShoppingInput" class="input-box" style="margin:0" placeholder="Ajouter article...">
                <button onclick="addShoppingItem()" style="background:var(--primary); color:white; border:none; padding:0 15px; border-radius:10px;"><i class="fa-solid fa-plus"></i></button>
            </div>
        </div>

        <!-- REPAS -->
        <div id="tab-meals" class="tab-content">
            <div style="padding:15px; font-weight:800; border-bottom:1px solid var(--border)">MENU DE LA SEMAINE</div>
            <div id="mealList" style="flex-grow:1; overflow-y:auto; padding:15px;"></div>
        </div>

        <!-- NOTES -->
        <div id="tab-notes" class="tab-content">
            <div style="padding:15px; font-weight:800; border-bottom:1px solid var(--border)">TABLEAU DE LA FAMILLE</div>
            <textarea id="notesArea" style="flex-grow:1; border:none; padding:20px; font-family:inherit; font-size:1.1rem; background:var(--card); color:var(--text); resize:none;" oninput="saveNotes()" placeholder="√âcrivez quelque chose ici..."></textarea>
        </div>
    </div>
</div>

<div id="settingsOverlay">
    <div class="modal">
        <h3><i class="fa-solid fa-sliders"></i> Configuration</h3>
        <button onclick="toggleTheme()" class="footer-btn" style="background:var(--header-bg); width:100%; margin-bottom:10px;">MODE CLAIR / SOMBRE</button>
        <button onclick="document.getElementById('icsInput').click()" class="footer-btn" style="background:var(--accent); width:100%; margin-bottom:10px;">IMPORTER .ICS (MANUEL)</button>
        <input type="file" id="icsInput" accept=".ics" style="display:none" onchange="importICS(this)">

        <div style="margin: 15px 0; padding: 10px; border: 1px solid var(--border); border-radius: 12px;">
            <h4 style="margin-top:0">Membres de la Famille</h4>
            <div id="membersList" style="margin-bottom:10px; display:flex; flex-wrap:wrap; gap:5px;"></div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="memberNameInput" class="input-box" style="margin:0; font-size:0.8rem;" placeholder="Nom">
                <input type="color" id="memberColorInput" value="#0EA5E9" style="width:40px; height:40px; border:none; border-radius:8px;">
                <button onclick="addMember()" style="background:var(--primary); color:white; border:none; padding:5px 10px; border-radius:8px;"><i class="fa-solid fa-plus"></i></button>
            </div>
        </div>

        <div style="margin: 15px 0; padding: 10px; border: 1px solid var(--border); border-radius: 12px;">
            <h4 style="margin-top:0">Calendriers Externes (Sync)</h4>
            <div id="externalCalendarsList" style="margin-bottom:10px; max-height:100px; overflow-y:auto;"></div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="externalUrlInput" class="input-box" style="margin:0; font-size:0.8rem;" placeholder="URL ICS (Google, etc.)">
                <button onclick="addExternalCalendar()" style="background:var(--primary); color:white; border:none; padding:5px 10px; border-radius:8px;"><i class="fa-solid fa-plus"></i></button>
            </div>
        </div>

        <div style="margin: 15px 0; padding: 10px; border: 1px solid var(--border); border-radius: 12px;">
            <h4 style="margin-top:0">Cadre Photo (URLs d'images)</h4>
            <div id="photosList" style="margin-bottom:10px; max-height:100px; overflow-y:auto;"></div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="photoUrlInput" class="input-box" style="margin:0; font-size:0.8rem;" placeholder="URL de l'image (jpg, png)">
                <button onclick="addPhoto()" style="background:var(--primary); color:white; border:none; padding:5px 10px; border-radius:8px;"><i class="fa-solid fa-plus"></i></button>
            </div>
        </div>

        <div style="margin: 15px 0; padding: 10px; border: 1px solid var(--border); border-radius: 12px;">
            <h4 style="margin-top:0">Localisation (M√©t√©o)</h4>
            <div style="display:flex; gap:5px; flex-direction:column;">
                <input type="text" id="cityInput" class="input-box" placeholder="Ville">
                <div style="display:flex; gap:5px;">
                    <input type="number" id="latInput" class="input-box" step="0.01" placeholder="Lat">
                    <input type="number" id="lonInput" class="input-box" step="0.01" placeholder="Lon">
                </div>
            </div>
        </div>

        <div style="margin: 15px 0; padding: 10px; border: 1px solid var(--border); border-radius: 12px;">
            <h4 style="margin-top:0">Collecte des Ordures (D√©but cycles)</h4>
            <div style="display:flex; gap:10px; flex-direction:column;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="font-size:0.8rem; width:80px;">Bleu (Recycl)</span>
                    <input type="date" id="wasteBlueInput" class="input-box" style="margin:0; font-size:0.8rem;">
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="font-size:0.8rem; width:80px;">Vert (Compost)</span>
                    <input type="date" id="wasteGreenInput" class="input-box" style="margin:0; font-size:0.8rem;">
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="font-size:0.8rem; width:80px;">Noir (D√©chets)</span>
                    <input type="date" id="wasteBlackInput" class="input-box" style="margin:0; font-size:0.8rem;">
                </div>
            </div>
        </div>

        <button onclick="saveConfig()" style="background:var(--primary); color:white; border:none; padding:15px; border-radius:12px; font-weight:800; width:100%; margin-bottom:15px;">APPLIQUER LA CONFIGURATION</button>

        <button onclick="clearAllEvents()" class="footer-btn" style="background:#ef4444; width:100%; margin-bottom:10px;">TOUT EFFACER</button>
        <button onclick="closeSettings()" class="footer-btn" style="background:#94a3b8; width:100%;">FERMER</button>
    </div>
</div>

<div id="photoFrame" style="display:none; position:fixed; inset:0; background:black; z-index:2000; cursor:pointer;" onclick="togglePhotoFrame(false)">
    <img id="photoFrameImg" style="width:100%; height:100%; object-fit:cover; transition: opacity 1s ease-in-out;" src="">
    <div style="position:absolute; bottom:20px; right:20px; background:rgba(0,0,0,0.5); color:white; padding:10px 20px; border-radius:30px; font-weight:800; pointer-events:none;">
        <div id="photoFrameClock" style="font-size:2rem;">00:00</div>
    </div>
</div>

<div id="modalOverlay">
    <div class="modal">
        <h3 style="margin:0 0 15px 0">√âv√©nement</h3>

        <div id="memberSelector" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid var(--border);"></div>

        <div id="iconBox" style="display:grid; grid-template-columns: repeat(5, 1fr); gap:10px; margin-bottom:15px;"></div>
        <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">
            <div id="previewIcon" style="font-size:2.5rem; color:var(--primary); min-width:50px; text-align:center;"></div>
            <input type="text" id="itemName" class="input-box" style="margin:0;" placeholder="Nom...">
        </div>
        <div style="display:flex; gap:10px;">
            <input type="time" id="timeStart" class="input-box">
            <input type="time" id="timeEnd" class="input-box">
        </div>
        <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; font-weight: 700;">
            <input type="checkbox" id="itemImportant" style="width: 20px; height: 20px;"> ‚≠ê IMPORTANT
        </label>
        <input type="color" id="itemColor" value="#BAE6FD" style="width:100%; height:40px; border:none; border-radius:8px; margin-bottom:15px;">
        <div style="display:flex; gap:10px;">
            <button onclick="handleSubmit()" class="footer-btn" style="background:var(--primary)">OK</button>
            <button id="btnDelete" onclick="handleDelete()" class="footer-btn" style="background:#ef4444; display:none;">SUPPR</button>
            <button onclick="closeModal()" class="footer-btn" style="background:#94a3b8">ANNULER</button>
        </div>
    </div>
</div>

<script>
    let currentViewDate = new Date();
    let activeData = { monthKey: null, day: null, id: null, icon: 'star', memberId: null };
    let rotationTimers = [];
    let tasks = [];
    let shoppingItems = [];
    let mealPlans = {};
    let members = [];
    let photoInterval = null;
    let appConfig = { city: "Lavaltrie", lat: 45.88, lon: -73.28, photos: [] };
    let photos = [];

    function getWaste(date) {
        const bins = []; const d = new Date(date); d.setHours(0,0,0,0);
        const diff = (startStr) => {
            if (!startStr) return NaN;
            const parts = startStr.split('-');
            const start = new Date(parts[0], parts[1] - 1, parts[2]);
            start.setHours(0,0,0,0);
            return Math.round((d - start) / (1000 * 60 * 60 * 24));
        };

        const dBlue = diff(appConfig.wasteBlueStart);
        if (!isNaN(dBlue) && dBlue % 14 === 0) bins.push('blue');
        const dGreen = diff(appConfig.wasteGreenStart);
        if (!isNaN(dGreen) && dGreen % 14 === 0) bins.push('green');
        const dBlack = diff(appConfig.wasteBlackStart);
        if (!isNaN(dBlack) && dBlack % 14 === 0) bins.push('black');
        return bins;
    }

    async function updateMeteo() {
        try {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${appConfig.lat}&longitude=${appConfig.lon}&current_weather=true`);
            const d = await res.json();
            document.getElementById('weatherWidget').innerHTML = `üå§Ô∏è ${Math.round(d.current_weather.temperature)}¬∞C ${appConfig.city}`;
        } catch(e) { }
    }

    async function updateImportantBanner() {
        const now = new Date(); now.setHours(0,0,0,0);
        let list = [];
        for(let i=0; i<3; i++) {
            let d = new Date(currentViewDate.getFullYear(), currentViewDate.getMonth() + i, 1);
            let mk = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            const res = await fetch(`/api/stickers/${mk}`);
            const data = await res.json();
            for(let day in data) {
                data[day].forEach(ev => {
                    let evDate = new Date(d.getFullYear(), d.getMonth(), day);
                    if(ev.isImportant && evDate >= now) list.push({...ev, fullDate: evDate});
                });
            }
        }
        list.sort((a,b) => a.fullDate - b.fullDate);
        const banner = document.getElementById('importantBanner');
        if(list.length > 0) {
            const next = list[0];
            const opt = { weekday: 'long', day: 'numeric', month: 'long' };
            document.getElementById('bannerText').innerText = `√Ä NE PAS MANQUER : ${next.name} (${next.fullDate.toLocaleDateString('fr-FR', opt)})`;
            banner.style.display = 'block';
        } else { banner.style.display = 'none'; }
    }

    function toggleTasks() { document.getElementById('taskPanel').classList.toggle('open'); }

    function showTab(tabId) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        const btn = document.querySelector(`.tab-btn[onclick="showTab('${tabId}')"]`);
        if(btn) btn.classList.add('active');
        document.getElementById(`tab-${tabId}`).classList.add('active');
        if(tabId === 'shopping') fetchShopping();
        if(tabId === 'meals') fetchMeals();
        if(tabId === 'notes') fetchNotes();
    }

    // T√ÇCHES
    async function fetchTasks() {
        const res = await fetch('/api/tasks');
        tasks = await res.json();
        renderTasks();
        renderTaskMemberSelector();
    }

    function renderTaskMemberSelector() {
        const box = document.getElementById('taskMemberSelector');
        box.innerHTML = `<div onclick="selectTaskMember(null)" style="cursor:pointer; padding:3px 8px; border-radius:10px; border:1px solid ${!activeMemberId ? 'var(--primary)' : 'var(--border)'}; font-size:0.7rem;">Tous</div>`;
        members.forEach(m => {
            box.innerHTML += `<div onclick="selectTaskMember('${m.id}')" style="cursor:pointer; padding:3px 8px; border-radius:10px; border:1px solid ${activeMemberId == m.id ? m.color : 'var(--border)'}; color:${m.color}; font-size:0.7rem; font-weight:800;">${m.name}</div>`;
        });
    }

    function selectTaskMember(id) {
        activeMemberId = id;
        renderTaskMemberSelector();
    }
    function renderTasks() {
        const list = document.getElementById('taskList');
        list.innerHTML = tasks.map((t) => {
            const member = members.find(m => m.id == t.memberId);
            const badge = member ? `<span style="background:${member.color}; color:white; font-size:0.6rem; padding:2px 6px; border-radius:10px; margin-right:5px;">${member.name}</span>` : '';
            return `<div style="display:flex; align-items:center; gap:10px; padding:10px; border-bottom:1px solid var(--border); font-size:0.9rem;">
                <input type="checkbox" ${t.done ? 'checked' : ''} onclick="toggleTask('${t.id}', ${!t.done})">
                <span style="flex-grow:1; ${t.done ? 'text-decoration:line-through; opacity:0.5':''}">
                    ${badge}${t.text}
                </span>
                <i class="fa-solid fa-trash" onclick="deleteTask('${t.id}')" style="color:#ef4444; cursor:pointer"></i>
            </div>`;
        }).join('');
    }
    async function addTask() {
        const input = document.getElementById('newTaskInput');
        const memberId = activeMemberId; // We need to track a selected member for tasks too
        if(input.value.trim()) {
            await fetch('/api/tasks', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({text: input.value, memberId}) });
            input.value = ''; fetchTasks();
        }
    }
    let activeMemberId = null;
    async function toggleTask(id, done) {
        await fetch(`/api/tasks/${id}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({done}) });
        fetchTasks();
    }
    async function deleteTask(id) {
        await fetch(`/api/tasks/${id}`, { method: 'DELETE' });
        fetchTasks();
    }

    // SHOPPING
    async function fetchShopping() {
        const res = await fetch('/api/shopping');
        shoppingItems = await res.json();
        renderShopping();
    }
    function renderShopping() {
        const list = document.getElementById('shoppingList');
        list.innerHTML = shoppingItems.map((item) => `<div style="display:flex; align-items:center; gap:10px; padding:10px; border-bottom:1px solid var(--border); font-size:0.9rem;"><input type="checkbox" ${item.done ? 'checked' : ''} onclick="toggleShopping('${item.id}', ${!item.done})"><span style="flex-grow:1; ${item.done ? 'text-decoration:line-through; opacity:0.5':''}">${item.text}</span><i class="fa-solid fa-trash" onclick="deleteShopping('${item.id}')" style="color:#ef4444; cursor:pointer"></i></div>`).join('');
    }
    async function addShoppingItem() {
        const input = document.getElementById('newShoppingInput');
        if(input.value.trim()) {
            await fetch('/api/shopping', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({text: input.value}) });
            input.value = ''; fetchShopping();
        }
    }
    async function toggleShopping(id, done) {
        await fetch(`/api/shopping/${id}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({done}) });
        fetchShopping();
    }
    async function deleteShopping(id) {
        await fetch(`/api/shopping/${id}`, { method: 'DELETE' });
        fetchShopping();
    }

    // REPAS
    async function fetchMeals() {
        const res = await fetch('/api/meals');
        mealPlans = await res.json();
        renderMeals();
    }
    function renderMeals() {
        const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
        const weekKey = getWeekKey(currentViewDate);
        const currentMeals = mealPlans[weekKey] || {};
        const list = document.getElementById('mealList');
        list.innerHTML = days.map(d => `
            <div style="padding:10px; border-bottom:1px solid var(--border);">
                <div style="font-size:0.7rem; color:var(--text-muted); font-weight:800;">${d}</div>
                <input type="text" class="input-box" style="margin:5px 0 0 0; padding:5px; font-size:0.85rem;"
                    value="${currentMeals[d] || ''}"
                    onchange="saveMeal('${weekKey}', '${d}', this.value)"
                    placeholder="Qu'est-ce qu'on mange ?">
            </div>
        `).join('');
    }
    async function saveMeal(weekKey, day, meal) {
        await fetch('/api/meals', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({weekKey, day, meal}) });
    }

    // NOTES
    async function fetchNotes() {
        const res = await fetch('/api/notes');
        const data = await res.json();
        document.getElementById('notesArea').value = data.text || "";
    }
    let notesTimeout = null;
    function saveNotes() {
        clearTimeout(notesTimeout);
        notesTimeout = setTimeout(async () => {
            const text = document.getElementById('notesArea').value;
            await fetch('/api/notes', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({text}) });
        }, 1000);
    }
    function getWeekKey(date) {
        const d = new Date(date);
        d.setHours(0, 0, 0, 0);
        d.setDate(d.getDate() + 4 - (d.getDay() || 7));
        const yearStart = new Date(d.getFullYear(), 0, 1);
        const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        return `${d.getFullYear()}-W${weekNo}`;
    }

    async function render() {
        const year = currentViewDate.getFullYear(), month = currentViewDate.getMonth();
        const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
        document.getElementById('monthDisplay').innerText = new Intl.DateTimeFormat('fr-FR', { month: 'long', year: 'numeric' }).format(currentViewDate);

        const res = await fetch(`/api/stickers/${monthKey}`);
        const stickers = await res.json();

        const grid = document.getElementById('calendar'); grid.innerHTML = '';
        const startIdx = new Date(year, month, 1).getDay();
        const totalDays = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < startIdx; i++) grid.innerHTML += `<div class="day-card" style="visibility:hidden"></div>`;

        // Ensure members are loaded for color coding
        if (members.length === 0) {
            const mRes = await fetch('/api/members');
            members = await mRes.json();
        }

        for (let d = 1; d <= totalDays; d++) {
            const date = new Date(year, month, d);
            const bins = getWaste(date);
            const card = document.createElement('div');
            card.className = `day-card ${new Date().toDateString() === date.toDateString() ? 'today' : ''}`;

            let evsHtml = '<div class="events-container">';
            if (stickers[d]) {
                stickers[d].forEach(s => {
                    const star = s.isImportant ? '<i class="fa-solid fa-star event-important-star"></i>' : '';
                    const timeRange = (s.timeStart || s.timeEnd) ? `<div class="event-time-line">${s.timeStart}${s.timeEnd ? ' - '+s.timeEnd : ''}</div>` : '';

                    const member = members.find(m => m.id == s.memberId);
                    const borderStyle = member ? `border-left: 6px solid ${member.color}` : '';

                    evsHtml += `<div class="event" style="background-color:${s.color}; ${borderStyle}" onclick="event.stopPropagation(); openModal('${monthKey}', ${d}, ${JSON.stringify(s).replace(/"/g, '&quot;')})">
                        <div class="event-title"><i class="fa-solid fa-${s.icon || 'star'}"></i> ${s.name}</div>
                        ${timeRange}
                        ${star}
                    </div>`;
                });
            }
            evsHtml += '</div>';
            const wasteHtml = `<div class="waste-icons">${bins.map(b => `<i class="fa-solid fa-${b==='blue'?'recycle':b==='green'?'leaf':'trash-can'} bin bin-${b}"></i>`).join('')}</div>`;
            card.innerHTML = `${wasteHtml}<div class="day-number">${d}</div>${evsHtml}`;
            card.onclick = () => openModal(monthKey, d);
            grid.appendChild(card);
        }

        rotationTimers.forEach(clearInterval);
        document.querySelectorAll('.events-container').forEach(c => {
            const evs = Array.from(c.querySelectorAll('.event'));
            if(evs.length > 2) {
                let i = 0; evs[0].classList.add('visible'); evs[1].classList.add('visible');
                rotationTimers.push(setInterval(() => {
                    evs.forEach(e => e.classList.remove('visible'));
                    i = (i + 2) % evs.length; evs[i].classList.add('visible');
                    if(evs[i+1]) evs[i+1].classList.add('visible'); else evs[0].classList.add('visible');
                }, 4000));
            } else evs.forEach(e => e.classList.add('visible'));
        });
        updateImportantBanner();
        fetchMeals();
    }

    async function handleSubmit() {
        const payload = {
            day: activeData.day,
            name: document.getElementById('itemName').value,
            icon: activeData.icon,
            color: document.getElementById('itemColor').value,
            timeStart: document.getElementById('timeStart').value,
            timeEnd: document.getElementById('timeEnd').value,
            isImportant: document.getElementById('itemImportant').checked,
            memberId: activeData.memberId
        };
        const url = activeData.id ? `/api/stickers/${activeData.monthKey}/${activeData.day}/${activeData.id}` : `/api/stickers/${activeData.monthKey}`;
        await fetch(url, { method: activeData.id ? 'PUT' : 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
        closeModal(); render();
    }

    function openModal(mKey, d, s = null) {
        activeData = { monthKey: mKey, day: d, id: s?.id, icon: s?.icon || 'star', memberId: s?.memberId || null };
        document.getElementById('itemName').value = s?.name || "";
        document.getElementById('timeStart').value = s?.timeStart || "";
        document.getElementById('timeEnd').value = s?.timeEnd || "";
        document.getElementById('itemColor').value = s?.color || "#BAE6FD";
        document.getElementById('itemImportant').checked = s?.isImportant || false;
        document.getElementById('btnDelete').style.display = s ? "block" : "none";
        setModalIcon(activeData.icon);
        renderMemberSelector();
        document.getElementById('modalOverlay').style.display = 'flex';
    }

    function renderMemberSelector() {
        const box = document.getElementById('memberSelector');
        box.innerHTML = `<div onclick="selectMember(null)" style="cursor:pointer; padding:5px 10px; border-radius:15px; border:2px solid ${!activeData.memberId ? 'var(--primary)' : 'var(--border)'}; font-size:0.8rem;">Famille</div>`;
        members.forEach(m => {
            box.innerHTML += `<div onclick="selectMember('${m.id}')" style="cursor:pointer; padding:5px 10px; border-radius:15px; border:2px solid ${activeData.memberId == m.id ? m.color : 'var(--border)'}; background:${activeData.memberId == m.id ? m.color+'22' : 'transparent'}; color:${m.color}; font-size:0.8rem; font-weight:800;">${m.name}</div>`;
        });
    }

    function selectMember(id) {
        activeData.memberId = id;
        renderMemberSelector();
    }

    function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }
    function setModalIcon(ico) { activeData.icon = ico; document.getElementById('previewIcon').innerHTML = `<i class="fa-solid fa-${ico}"></i>`; }
    async function handleDelete() { if(confirm("Supprimer ?")) { await fetch(`/api/stickers/${activeData.monthKey}/${activeData.day}/${activeData.id}`, { method: 'DELETE' }); closeModal(); render(); } }
    async function clearAllEvents() { if(confirm("Vider tout ?")) { await fetch('/api/stickers/clear-all', { method: 'DELETE' }); render(); closeSettings(); } }
    function toggleTheme() { document.getElementById('bodyRoot').classList.toggle('dark-mode'); localStorage.setItem('theme', document.getElementById('bodyRoot').classList.contains('dark-mode') ? 'dark' : 'light'); }
    if (localStorage.getItem('theme') === 'dark') document.getElementById('bodyRoot').classList.add('dark-mode');

    function togglePhotoFrame(show) {
        const frame = document.getElementById('photoFrame');
        if (show) {
            frame.style.display = 'block';
            startPhotoRotation();
        } else {
            frame.style.display = 'none';
            clearInterval(photoInterval);
        }
    }

    function startPhotoRotation() {
        if (photos.length === 0) {
            document.getElementById('photoFrameImg').src = "";
            return;
        }
        let idx = 0;
        const img = document.getElementById('photoFrameImg');
        const update = () => {
            if (photos.length === 0) return;
            img.style.opacity = 0;
            setTimeout(() => {
                if (photos.length === 0) return;
                const src = photos[idx];
                img.src = src.includes('?') ? src + '&sig=' + Math.random() : src + '?sig=' + Math.random();
                img.style.opacity = 1;
                idx = (idx + 1) % photos.length;
            }, 1000);
        };
        update();
        photoInterval = setInterval(update, 10000);

        // Update clock in photo frame
        const clockUpdate = () => {
            document.getElementById('photoFrameClock').innerText = new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
        };
        clockUpdate();
        // The main interval already handles global clock, but we need one for the frame if it's separate
    }

    async function toggleScreen(power) {
        await fetch('/api/system/screen', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({power}) });
        if(power === 0) {
            const overlay = document.createElement('div');
            overlay.id = "screenSleepOverlay";
            overlay.style = "position:fixed; inset:0; background:black; z-index:9999; cursor:pointer; display:flex; align-items:center; justify-content:center; color:#333; font-size:1.2rem; font-weight:800;";
            overlay.innerHTML = "√âcran en veille... Cliquez pour r√©activer";
            overlay.onclick = () => { toggleScreen(1); document.body.removeChild(overlay); };
            document.body.appendChild(overlay);
        }
    }

    async function openSettings() {
        document.getElementById('settingsOverlay').style.display = 'flex';
        const res = await fetch('/api/config');
        appConfig = await res.json();

        document.getElementById('cityInput').value = appConfig.city || "";
        document.getElementById('latInput').value = appConfig.lat || "";
        document.getElementById('lonInput').value = appConfig.lon || "";

        document.getElementById('wasteBlueInput').value = appConfig.wasteBlueStart || "";
        document.getElementById('wasteGreenInput').value = appConfig.wasteGreenStart || "";
        document.getElementById('wasteBlackInput').value = appConfig.wasteBlackStart || "";

        fetchCalendars();
        fetchMembers();
        renderPhotosList();
    }

    function renderPhotosList() {
        const list = document.getElementById('photosList');
        const currentPhotos = appConfig.photos || [];
        list.innerHTML = '';
        if (currentPhotos.length === 0) {
            list.innerHTML = '<div style="font-size:0.7rem; color:var(--text-muted)">Aucune photo</div>';
            return;
        }
        currentPhotos.forEach(url => {
            const div = document.createElement('div');
            div.style = "display:flex; justify-content:space-between; align-items:center; font-size:0.7rem; margin-bottom:5px; background:var(--bg); padding:5px; border-radius:5px;";

            const span = document.createElement('span');
            span.style = "overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:200px;";
            span.textContent = url;

            const icon = document.createElement('i');
            icon.className = "fa-solid fa-trash";
            icon.style = "color:#ef4444; cursor:pointer";
            icon.onclick = () => removePhoto(url);

            div.appendChild(span);
            div.appendChild(icon);
            list.appendChild(div);
        });
    }

    async function addPhoto() {
        const url = document.getElementById('photoUrlInput').value;
        if(url) {
            const updatedPhotos = [...(appConfig.photos || []), url];
            await savePhotosConfig(updatedPhotos);
            document.getElementById('photoUrlInput').value = '';
        }
    }

    async function removePhoto(url) {
        if(confirm("Supprimer cette photo ?")) {
            const updatedPhotos = (appConfig.photos || []).filter(u => u !== url);
            await savePhotosConfig(updatedPhotos);
        }
    }

    async function savePhotosConfig(updatedPhotos) {
        await fetch('/api/config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ photos: updatedPhotos })
        });
        appConfig.photos = updatedPhotos;
        photos = updatedPhotos;
        renderPhotosList();

        // Restart photo rotation if frame is open
        const frame = document.getElementById('photoFrame');
        if (frame.style.display === 'block') {
            clearInterval(photoInterval);
            startPhotoRotation();
        }
    }

    async function saveConfig() {
        const payload = {
            city: document.getElementById('cityInput').value,
            lat: parseFloat(document.getElementById('latInput').value),
            lon: parseFloat(document.getElementById('lonInput').value),
            wasteBlueStart: document.getElementById('wasteBlueInput').value,
            wasteGreenStart: document.getElementById('wasteGreenInput').value,
            wasteBlackStart: document.getElementById('wasteBlackInput').value
        };
        await fetch('/api/config', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
        appConfig = { ...appConfig, ...payload };
        updateMeteo();
        render();
        alert("Configuration sauvegard√©e !");
    }

    async function fetchCalendars() {
        const res = await fetch('/api/calendars');
        const urls = await res.json();
        const list = document.getElementById('externalCalendarsList');
        list.innerHTML = urls.map(url => `<div style="display:flex; justify-content:space-between; align-items:center; font-size:0.7rem; margin-bottom:5px; background:var(--bg); padding:5px; border-radius:5px;"><span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:200px;">${url}</span><i class="fa-solid fa-trash" onclick="removeExternalCalendar('${url}')" style="color:#ef4444; cursor:pointer"></i></div>`).join('') || '<div style="font-size:0.7rem; color:var(--text-muted)">Aucun calendrier externe</div>';
    }

    async function fetchMembers() {
        const res = await fetch('/api/members');
        members = await res.json();
        const list = document.getElementById('membersList');
        list.innerHTML = members.map(m => `<div style="display:flex; align-items:center; gap:5px; background:var(--bg); padding:5px 8px; border-radius:20px; font-size:0.75rem; font-weight:800; border:2px solid ${m.color}">
            <span style="color:${m.color}">${m.name}</span>
            <i class="fa-solid fa-times" onclick="removeMember('${m.id}')" style="cursor:pointer; font-size:0.6rem; opacity:0.5"></i>
        </div>`).join('') || '<div style="font-size:0.7rem; color:var(--text-muted)">Aucun membre d√©fini</div>';
    }

    async function addMember() {
        const name = document.getElementById('memberNameInput').value;
        const color = document.getElementById('memberColorInput').value;
        if(name) {
            await fetch('/api/members', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({name, color}) });
            document.getElementById('memberNameInput').value = '';
            fetchMembers();
        }
    }

    async function removeMember(id) {
        if(confirm("Supprimer ce membre ?")) {
            await fetch(`/api/members/${id}`, { method: 'DELETE' });
            fetchMembers();
        }
    }

    async function addExternalCalendar() {
        const url = document.getElementById('externalUrlInput').value;
        if(url) {
            await fetch('/api/calendars', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({url}) });
            document.getElementById('externalUrlInput').value = '';
            openSettings();
        }
    }

    async function removeExternalCalendar(url) {
        if(confirm("Supprimer ce calendrier ?")) {
            await fetch('/api/calendars', { method: 'DELETE', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({url}) });
            openSettings();
        }
    }

    async function importICS(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            const content = e.target.result;
            // Simple approach: send to a new manual import endpoint or parse here.
            // Let's add a backend endpoint for this to reuse the node-ical logic.
            await fetch('/api/calendars/import-manual', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({content})
            });
            render();
            alert("Importation r√©ussie");
        };
        reader.readAsText(file);
    }

    function closeSettings() { document.getElementById('settingsOverlay').style.display = 'none'; }
    function changeMonth(v) { currentViewDate.setMonth(currentViewDate.getMonth() + v); render(); }
    function goToday() { currentViewDate = new Date(); render(); }

    let zoomLevel = parseFloat(localStorage.getItem('zoomLevel')) || 1;
    document.documentElement.style.setProperty('--zoom-factor', zoomLevel);

    function changeZoom(v) {
        zoomLevel = Math.max(0.5, Math.min(2, zoomLevel + v));
        document.documentElement.style.setProperty('--zoom-factor', zoomLevel);
        localStorage.setItem('zoomLevel', zoomLevel);
    }
    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'}); }, 1000);

    const icons = ['star', 'soccer-ball', 'broom', 'cart-shopping', 'utensils', 'car', 'cake-candles', 'pills', 'stethoscope', 'laptop', 'dog', 'plane', 'school', 'dumbbell', 'heart'];
    function initIcons() {
        const box = document.getElementById('iconBox'); box.innerHTML = '';
        icons.forEach(ico => {
            const b = document.createElement('button');
            b.style = "padding:10px; border-radius:8px; border:1px solid var(--border); background:var(--card); color:var(--text); cursor:pointer;";
            b.innerHTML = `<i class="fa-solid fa-${ico}"></i>`;
            b.onclick = () => setModalIcon(ico);
            box.appendChild(b);
        });
    }

    async function initApp() {
        try {
            const res = await fetch('/api/config');
            if (res.ok) {
                const serverConfig = await res.json();
                appConfig = { ...appConfig, ...serverConfig };
                photos = appConfig.photos || [];
            }
        } catch(e) { console.error("Config load error", e); }

        try { initIcons(); } catch(e) {}
        try { updateMeteo(); } catch(e) {}
        try { render(); } catch(e) {}
        try { fetchTasks(); } catch(e) {}
        try { fetchNotes(); } catch(e) {}
    }

    initApp();
</script>
</body>
</html>
